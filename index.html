<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bar Chart Example</title>
  <script type="text/javascript" src="http://d3js.org/d3.v2.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"> </script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <link rel="stylesheet" type="text/css" href="mystyle.css">


</head>
<body>



<script type="text/javascript">

var w = 1400;
var h = 750;
var margin = 20;
      d3.json("http://localhost:8000/data111.json", function (error,data) {
        if(error){
          console.log("Error loading data")
        }
     

var data = data;

 

 //make Key from 1908 to 2009 -- for now it's till 1949
var dataset = [];
var start = 1908;
var end = 2009
var len = end-start;
for (var i = start; i <= end; i++) {
    dataset.push({
        key: i,
        value:0,
        aboard:0,
        fatalities:0
    });
}

for (var i = 0; i < data.Date.length; i++) {
 
var year = data.Date[i].substr(data.Date[i].length - 4);
var IntYear = parseInt(year);
var aboard = data.Aboard[i];
var IntAboard = parseInt(aboard);
var fatalities = data.Fatalities[i];
var IntFatalities = parseInt(fatalities);
dataset[end-IntYear].value +=1;
dataset[end-IntYear].aboard +=IntAboard;
dataset[end-IntYear].fatalities +=IntFatalities;

}


var key = function(d) {
  return d.key;
};

var value = function(d) {
  return d.value;
};
console.log(dataset);
 
//Create SVG element
var svg = d3.select("body")
      .append("svg")
      .attr("width", w)
      .attr("height", h);
var max = d3.max(dataset, function(d) { return +d.value;} );




var xScale = d3.scale.ordinal()
        .domain(d3.range(dataset.length+1))
        .rangeRoundBands([0, w], 0.05); 
var hScale = d3.scale.ordinal()
        .domain(d3.range(end+1,start,-1))
        .rangeRoundBands([0, w], 0.05);       


var yScale = d3.scale.linear()
                     .domain([0, max+5])
                     .range([h-margin*1.8, 0]);
        
var x_axis = d3.svg.axis().scale(hScale).ticks(5);


       
var y_axis = d3.svg.axis().scale(yScale).orient("left");

d3.select("svg")
  .append("g")
    .attr("class","x axis")
    .attr("transform","translate(0,"+(h-margin*2)+")")
  .call(x_axis)
  .selectAll("text")
    .attr("y", 0)
    .attr("x", 9)
    .attr("dy", ".35em")
    .attr("transform", "rotate(90)")
    .style("text-anchor", "start");
    
//creat tip
var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
   
    return "<strong>Year :</strong> <span style='color:red'>" + (end-d.key+start+1)  + "</span>"
    +"<br>" +"<strong>Planes Crashed:</strong> <span style='color:red'>" + d.value  + "</span>"
    +"<br>" + "<strong>Total Aboard:</strong> <span style='color:red'>" + d.aboard  + "</span>"
     +"<br>" + "<strong>Total Fatalities:</strong> <span style='color:red'>" + d.fatalities  + "</span>";

    

  })

d3.select("svg")
  .append("g")
    .attr("class","y axis")
    .attr("transform","translate("+margin*1.5+",0)")
  .call(y_axis);

  svg.call(tip);

 function drill(d, i) {
        console.log(d.value); //data object
    }


//Create bars
svg.selectAll("rect")
   .data(dataset, key)
   .enter()
   .append("rect")
   .attr("x", function(d, i) {
    return xScale(i);
   })
   .attr("y", function(d) {
    return yScale(d.value);
   })
   .attr("width", xScale.rangeBand())
   .attr("height", function(d) {
    return (yScale(0) - yScale(d.value));
   })
   .attr("fill", function(d) {
    debugger;
     return "rgb("+ (250-(d.value  *2))+", 30, 40)";
   })
   .on('mouseover', tip.show)
  .on('mouseout', tip.hide)
   .on("click", drill);
  //Tooltip
  // .on("mouseover", function(d) {
  //   //Get this bar's x/y values, then augment for the tooltip
  //   var xPosition = parseFloat(d3.select(this).attr("x")) + xScale.rangeBand() / 2;
  //   var yPosition = parseFloat(d3.select(this).attr("y")) + 14;
    
  //   //Update Tooltip Position & value
  //   d3.select("#tooltip")
  //     .style("left", xPosition + "px")
  //     .style("top", yPosition + "px")
  //     .select("#value")
  //     .text(d.value);
  //   d3.select("#tooltip").classed("hidden", false)
  // })
  // .on("mouseout", function() {
  //   //Remove the tooltip
  //   d3.select("#tooltip").classed("hidden", true);
  // })  ;

// //Create labels
svg.selectAll("text")
   .data(dataset, key)
   .enter()
   .append("text")
   .text(function(d) {
    return d.value;
   })
   .attr("text-anchor", "middle")
   .attr("x", function(d, i) {
    return xScale(i) + xScale.rangeBand() / 2;
   })
   .attr("y", function(d) {
    return yScale(d.value) + 4;
   })
   .attr("font-family", "sans-serif") 
   .attr("font-size", "4px")
   .attr("fill", "white");




})   
</script>
</body>
</html>